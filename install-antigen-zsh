#!/usr/bin/env sh

set -eu

. /etc/os-release
cat /etc/os-release
echo
echo ============================================
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo "$ID | ${VERSION_ID:- - } | ${PRETTY_NAME:- - }"
echo ============================================
echo

main() {
  set_max_user_watches
	get_packages_to_install
	install_packages
	install_zsh
}

set_max_user_watches() {
	echo 'fs.inotify.max_user_watches=524288' | sudo tee /etc/sysctl.d/10_max_user_watches >/dev/null
}

get_packages_to_install() {
	PACKAGES="curl git procps zsh neovim exa"

	if [ "$ID" = "centos" ] && [ $VERSION_ID -le 8 ]; then
		PACKAGES=$(echo $PACKAGES | sed -r -e 's/\<neovim\>/vim/' -e 's/\<exa\>//')
	fi
}

install_packages() {
	# evaluates the package manager
	PKG_MANAGER_PATH=$({ command -v apk || command -v apt || command -v dnf || command -v yum || command -v zypper || command -v pacman; })

	# /usr/bin/dnf -> dnf
	PKG_MANAGER=${PKG_MANAGER_PATH##*/}

	case "$PKG_MANAGER" in
	apk)
		sudo apk add $PACKAGES
		;;

	apt)
		apt update
		sudo apt -y install $PACKAGES
		;;

	dnf)
		sudo dnf -y install $PACKAGES
		;;

	pacman)
		sudo pacman -Sy --noconfirm $PACKAGES
		;;

	yum)
		sudo yum install -y $PACKAGES
		;;

	zypper)
		sudo zypper install -y $PACKAGES
		;;

	*)
		echo "Fatal Error: No supported package manager found!"
		exit 1
		;;

	esac
}

install_zsh() {
	echo "Installing ..."
	[ -d ~/.local/bin ] || mkdir --parents ~/.local/bin
	curl https://raw.githubusercontent.com/zsh-users/antigen/master/bin/antigen.zsh >~/.local/bin/antigen.zsh
}

main "$@"
